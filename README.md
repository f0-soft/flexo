Flexo
=====

## Инструкция по установке
* Перед запуском провести установку зависимостей ```npm install```
* Для запуска требуется установка ```nodeunit``` через ```npm -g i nodeunit```
* Перед запуском провести установку зависимостей ```npm install``` (требуется ```f0.argstype``` и ```f0.rabbit```) 
* Для тестов с настоящим ```rabbit```, надо в тесте закомментировать строку ```mock = true;```
* Перед запуском с настоящим ```rabbit``` следует очистить коллекции ```test``` и ```test_join```
* Запуск теста: ```nodeunit test/index.js```
* Очистка mongo и redis: ```mongo --eval 'db.test.remove(); db.test_join.remove();' && redis-cli FLUSHALL```



## TODO
* поддержка хуков на Pre-/Post- Find/Insert/Modify/Delete, способные предотвратить действие;
* поддержка уникальных индексов, предотвращающих создание дублирующих документов;
* поддержка вычисляемых полей;
* валидация документов при Insert/Modify.



## Схемы ```flexo```
```js
// название схемы
// под этим именем схема попадает в глобальный объект
exports.name: 'test';


// корень
// содержит изменяемые поля
// `_id`, `tsCreate`, `tsUpdate` добавляются автоматически
// ключ - название поля
// значение - объект со свойствами поля:
// * type - тип в БД: boolean, number, string, array, id
// * of - определяет вложенный тип данных масива, когда type == array, содержит один из типов: boolean, number, string, id
// * from - содержит название коллекции на которую ссылается поле
// * link - содержит название пути, который должен быть встроен в документы текущей коллекции
// * validation - объект правил валидации значений поля, где ключ - название метода валидации, значение - массив аргументов метода (используется библиотека validator)
// * messages - объект сообщений об ошибке валидации, где ключ - название метода валидации, значение - строка сообщения
// * title - название поля для админки
// * description - расширенное описание поля для админки
exports.root: {
    name: { type: 'string', validation: {len: [0, 20]}, messages: { len: 'Введите значение длиной не более 20 символов' } },
    inn: { type: 'string' },
    index: { type: 'number' },
    comment: { type: 'string' },
    join_id: { type: 'id' }, // автоматически обязательное поле из-за джойна
    array_of_id: { type: 'array', of: 'id', from: 'test_join', link: 'array_of_id' } // может быть пустым
};


// присоединения
// определяют неизменяемые поля докуемнта, значения которых втягиваются из других документов
exports.join: {
    test_join: { // название схемы
        rename: 'tj', // префикс присоединяемых полей; надо удостовериться, работает ли этот механизм
        fields: [ 'name', 'inn', 'comment' ], // перечень присоединяемых полей; `_id` добавляется автоматически
        depend: [ 'root', 'join_id' ] // объявление правила, определяющего _id присоединяемого документа: название группы/корень, название поля группы/корня
    }
};



// пользовательские функции (хуки), выполняющиеся до/после операции создания/модификации документа
// каждый хук вызывается с объектом в переменной this, у которого есть следующие ключи:
// * db - объект, контейнер методов flexo (find, aggregate, insert, modify, delete)
// * schemes - объект, справочник всех схем, доступных flexo, где за каждым ключом скрывается объект со свойствами:
// * * dict - справочник по текущей схеме
// * * scheme - схема из файла
// * request - обрабатываемый запрос
// хук обязательно должен рано или поздно вызвать переданный ему коллбек, с ошибкой или без
exports.before: { // на данный момент может содержать только `insert`, `modify`
    insert: [ // функции в массиве запускаются через async.parallel
        function( callback ) { return callback( null, true ); }
    ],
    modify: [
        function( callback ) { return callback( null, true ); }
    ]
};
exports.after: { // может содержать только `insert`, `modify`
    insert: [
        function( callback ) { return callback( null, true ); }
    ],
    modify: [
        function( callback ) { return callback( null, true ); }
    ]
};



// НЕ РАБОТАЕТ
// уникальные значения
// содержит индексы, которые должны быть уникальными на базу
// индекс может быть по 1 полю или более
// индекс может включать в себя поля только из корневого блока
exports.unique: [
    [ 'inn' ]
];
```



## init( options, callback )
Производит инициализацию библиотеки.

Параметры:
* ```options``` - объект
	* ```storage``` - объект, содержит функции работы с хранилищем (```find```, ```insert```, ```modify```, ```delete```)
	* ```schemes``` - объект, содержит доступные схемы со справочниками
* ```callback( error, collection )``` - функция
	* ```collection``` - объект, содержит функции работы с библиотекой: ```find```, ```insert```, ```modify```, ```delete```

Пример ```schemes```
```
var schemes = {
	orders: {
		scheme: require( './test.schemes/orders.js' ),
		dict: {
			// все поля документа, влючая системные _id, tsCreate, tsUpdate
			all: ['_id', 'tsCreate', 'tsUpdate', 'number', 'comments', 'services'],

			// изменяемые поля корневого блока
			mutable: ['number', 'comments', 'services'],

			// поля корневого блока от которых зависят джойны
			joinProperties: [],

			// названия схем присоединяемых блоков
			joins: [],

			types: { // справочник типов всех полей (значения полей из схемы), type обязателен
				_id: {type: 'id'},
				tsCreate: {type: 'number'},
				tsUpdate: {type: 'number'},
				number: { type: 'string' },
				comments: { type: 'string' },
				services: { type: 'array', of: 'id', scheme: 'test_join' }
			}
		}
	},
	test: {
		scheme: require( './test.schemes/test.js' ),
		dict: {
			// все поля документа, влючая системные _id, tsCreate, tsUpdate
			all: ['_id', 'tsCreate', 'tsUpdate', 'name', 'inn', 'comment', 'join_id', 'array_of_id', 'test_join__id', 'test_join_name', 'test_join_inn', 'test_join_comment'],

			// изменяемые поля корневого блока
			mutable: ['name', 'inn', 'comment', 'join_id', 'array_of_id'],

			// поля корневого блока от которых зависят джойны
			joinProperties: ['join_id'],

			// названия схем присоединяемых блоков
			joins: ['test_join'],

			types: { // справочник типов всех полей (значения полей из схемы), type обязателен
				_id: {type: 'id'},
				tsCreate: {type: 'number'},
				tsUpdate: {type: 'number'},
				name: { type: 'string', validation: {len: [0, 20]}, messages: {} },
				inn: { type: 'string' },
				comment: { type: 'string' },
				join_id: { type: 'id' },
				array_of_id: { type: 'array', of: 'id', scheme: 'test_join' },
				test_join__id: {type: 'id'},
				test_join_name: { type: 'string' },
				test_join_inn: { type: 'string' },
				test_join_comment: { type: 'string' }
			}
		}
	}
};

```



## container
Контейнер функций работы с проинициализированной библиотекой ```Flexo```.
Содержит методы, предоставляющие доступ к документам по заданной схеме

Документы включают в себя:
* собственные поля;
* присоединенные из иных документов поля.



### container.find( scheme, fields, query, options, callback )
Осуществляет поиск документов в хранилище.
Возвращает удовлетворяющие запросу документы (и их количество).

Параметры:
* ```request``` - объект
    * ```name``` - строка, содержит название схемы
    * ```fields``` - массив, содержит названия полей, с которыми надо вернуть документы
    * ```query``` - объект, поисковый запрос Mongo
    * ```options``` - объект
        * ```[count]``` - логическое, опция запроса количества документов удовлетворяющих запросу
        * ```[limit]``` - число, ограничение количества результатов поиска
        * ```[skip]``` - число, смещение ограничения количества результатов поиска
        * ```[sort]``` - объект или массив объектов ```sort```, правило сортировки Mongo
* ```callback( error, data )``` - функция
    * ```data``` - объект
	    * ```result``` - массив, содержит объекты документов
	    * ```[count]``` - число, общее количество удовлетворяющих запросу документов



### container.aggregate( scheme, pipeline, callback )
Производит аггреацию, вызывает аггрегацию Rabbit.
 
Параметры:
* ```request``` - объект
    * ```name``` - строка, содержит название схемы
    * ```pipeline``` - массив, содержит последовательность агрегации в естественном виде
* ```callback( error, documents )``` - строка, содержит название схемы
    * ```documents``` - массив, содержит результаты агрегации
    
Запрос к rabbit.aggregate( request, callback ):
* ```request``` - массив
    * ```collection_name``` - строка, название коллекции
    * ```pipeline``` - массив, содержит объекты команд агрегации
* ```callback( error, data )``` - функция
    * ```data``` - массив, содержит результаты агрегации



### container.insert( scheme, fields, document, options, callback )
Проверяет полученные документы, присоединяет к ним зависимые блоки, сохраняет результирующие документы в хранилище.
Возвращает созданные документы.

Документ может содержать только поля, относящиеся к корневому блоку документа.
Документ не может содержать служебные поля: ```_id```, ```tsCreate```, ```tsUpdate```.
Для документа обязательными являются поля, по которым осуществляется присоединение зависимых блоков.
Параметры документа ```tsCreate``` и ```tsUpdate``` создаются на уровне метода.

Параметры:
* ```request``` - объект
    * ```scheme``` - строка, содержит название схемы
    * ```fields``` - массив, содержит названия полей, с которыми надо вернуть документы
    * ```documents``` - массив
        * ```*``` - объект, содержит поля нового документа
    * ```options``` - объект
* ```callback( error, documents )``` - функция
	* ```documents``` - массив, содержит объекты сохраненных документов



### container.modify( scheme, query, options, callback )
Производит обновление параметров документов в хранилище.
Возвращает массив измененных документов, сокращенных до ```_id```, ```tsUpdate```.

Параметры:
* ```request``` - объект
    * ```name``` - строка, содержит название схемы
    * ```query``` - объект или массив объектов ```query```
	    * ```selector``` - объект, поисковый запрос Mongo, обязательно должен содержать поля ```_id``` и ```tsUpdate```
	    * ```properties``` - объект новых значений
    * ```options``` - объект
* ```callback( error, documents )``` - функция
	* ```documents``` - массив, содержит объекты документов, сокращенных до ```_id```, ```tsUpdate```



### container.delete( scheme, query, options, callback )
Удаляет заданные документы в хранилище.
Возвращает массив удаленных документов, сокращенных до ```_id```.

Параметры:
* ```request``` - объект
    * ```name``` - строка, содержит название схемы
    * ```query``` - массив
	    * ```*``` - объект, поисковый запрос Mongo, обязательно должен содержать поля ```_id``` и ```tsUpdate```
    * ```options``` - объект
* ```callback( error, documents )``` - функция
	* ```documents``` - массив, содержит объекты удаленных документов, сокращенные до ```_id```
